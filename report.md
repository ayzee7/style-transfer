# Отчет по проекту "Перенос стиля в телеграм-ботах"

<b>Цель работы:</b> <i>реализация модели Neural Style Transfer, а также Telegram бота, способного обрабатывать присылаемые пользователем фотографии и отправить обратно сгенерированное фото</i>

### Часть I. Реализация модели NST

Изначально я использовал в качестве модели заранее обученную VGG19 из модуля `torchvision.models`. Однако впоследствии я остановился на модели Adaptive Instance Normalization, или сокращенно AdaIN, которая также берет за основу VGG19.

Данное решение основано на нескольких факторах:

- Меньшее потребление ресурсов
- Более качественный результат (минимизированные style и content лоссы)
- Обработка происходит гораздо быстрее
- Возможность легко настраивать степень переноса стиля

Реализацию данной модели я позаимствовал из [этого репозитория](https://github.com/irasin/Pytorch_AdaIN), также как и скрипт обучения модели и генерации фото с небольшими корректировками.

Рассмотрим из чего состоит модель:
- `adain_model.py` -- описание класса модели, а также алгоритмы генерации фото, вычисления лоссов для обучения и денормализаци.
- `adain_dataset.py` -- класс для подготовки датасетов для обучения модели
- `train_network.py` -- обучение модели
- `transfer_adain.py` -- генерация фото
- `transfer.py` -- генерация фото без использования модели AdaIN

#### Проблемы, возникшие на данном этапе:
1. Обучение и генерация фото происходила очень долго

Причиной этого стала библиотека PyTorch, которая в PyCharm Packages по умолчанию устанавливается как `cpu-only` версия, то есть не использующая CUDA. Эту проблему я решил, воспользовавшись [официальным руководством по установке данного модуля](https://pytorch.org/get-started/locally/)


### Часть II. Реализация Telegram бота

Бот был написан с помощью модуля `pyTelegramBotAPI` без использования асинхронности (в будущем планирую переписать бота под модуль `aiogram` с поддержкой асинхронности).

У бота имеются 2 хендлера, способные обрабатывать следующие команды:
- `/start` -- начало работы бота, а также информация об использовании бота
- `/transfer` -- процесс переноса стиля

Последний хендлер вызывает цепь хендлеров отвечающие за считывание присылаемых пользователем картинок

Перенос стиля работает следующим образом:
1. При введении команды `/transfer` бот просит пользователя прислать фото, с которого будет перенесен стиль (style image)
2. После того, как бот получит первое фото и сохранит его в указанной директории, он попросит пользователя прислать фото, с которого будет перенесено содержание (content image)
3. После получения второго фото, бот вызывает функцию из `transfer_adain.py`, которая на выходе дает сгенерированное моделью фото, сохраняет его в формате `.jpg` и отправляет пользователю

#### Проблемы, возникшие на данном этапе:
1. Требовалось постоянно заново вводить команду `/transfer` самостоятельно, что крайне неудобно и долго

Для решения данной проблемы я завел переменную `ReplyKeyboardMarkup`, которая вызывает кнопку по нажатии которой команда вводилась автоматически. Это сделало использование бота гораздо более эффективным и удобным

2. Картинка сохранялась в ужасном качестве

Эта проблема связана с тем, что сообщение с картинкой сохраняется в виде массива типа PhotoSize, где последний элемент массива соответствует нативному разрешению загружаемой картинки. Поэтому важно при сохранении картинки из сообщения в методе `get_file` указывать `message.photo[-1].file_id`

### Часть III. Deploy бота.

В качестве хостинга была выбрана платформа Heroku. Для реализации бесперебойной работы бота потребовалось заменить Polling на Webhook. Для этого я воспользовался библиотекой `Flask`, предложенной в примерах реализации вебхука в модуле `pyTelegramBotAPI`

#### Проблемы, возникшие на данном этапе:

1. Ошибка билда бота из-за нехватки памяти

Ошибка заключалась в том, что память, которую Heroku выделяет под проект, помещает в себя только `cpu-only` версию библиотеки `PyTorch`. Необходимую версию (а также версию Python в файле `runtime.txt`) пришлось вручную обозначить в файле `requirements.txt` вместе с остальными необходимыми модулями.

2. Бот крашится при обработке фото

Из-за большого разрешения картинок у бота также могла переполниться память в Heroku. Чтобы избежать подобных ситуаций, после загрузки фотографий и нормализации их в тензоры, фото удаляются, а загруженные размеры сжимаются до 85% с каждой стороны от нативного разрешения с помощью метода `torchvision.transforms.Resize()`

## Итог

- Был реализован бот, который может принимать картинки стиля и содержания, отсылаемые пользователем и на их основе генерировать фото с перенесенным стилем с одной картинки на другую. 
- В данный момент бот бесперебойно работает на хостинге Heroku.
- Среднее время обработки фото занимает не более 2 минут.
- Пользователи, тестировавшие бота, остались довольны результатом

#### Что можно добавить:

- Возможность изменить степень перенесения стиля с одной картинки на другую (за это отвечает переменная `alpha` в методе `generate` класса `Model`)
- Асинхронность с помощью библиотеки `aiogram`
- Больше функций взаимодействия с ботом

## Источники:
- [AdaIN model example](https://github.com/irasin/Pytorch_AdaIN)
- [PyTorch NST example](https://pytorch.org/tutorials/advanced/neural_style_tutorial.html)
- [pyTelegramBotAPI](https://github.com/eternnoir/pyTelegramBotAPI)
- [Original Telegram API](https://core.telegram.org/bots/api)
- [Deploy on Heroku](https://towardsdatascience.com/how-to-deploy-a-telegram-bot-using-heroku-for-free-9436f89575d2)


